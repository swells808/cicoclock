---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/NEW_face_verifications.sql
  - src/integrations/supabase/types.ts
autonomous: true

must_haves:
  truths:
    - "face_verifications table exists with all columns needed for Phase 1-3"
    - "company_features table has face_verification boolean column"
    - "RLS policies scope face_verifications to company_id"
    - "TypeScript types reflect new schema"
  artifacts:
    - path: "supabase/migrations/NEW_face_verifications.sql"
      provides: "face_verifications table, company_features column, RLS policies, indexes"
      contains: "CREATE TABLE public.face_verifications"
    - path: "src/integrations/supabase/types.ts"
      provides: "Regenerated Supabase types including face_verifications and face_verification column"
      contains: "face_verifications"
  key_links:
    - from: "face_verifications.company_id"
      to: "companies.id"
      via: "REFERENCES"
      pattern: "REFERENCES public.companies"
    - from: "face_verifications.time_entry_id"
      to: "time_entries.id"
      via: "REFERENCES"
      pattern: "REFERENCES public.time_entries"
---

<objective>
Create the database migration for the face_verifications table and add the face_verification toggle column to company_features. Regenerate Supabase TypeScript types.

Purpose: All downstream work (edge function, UI, verification pipeline) depends on this schema existing.
Output: Migration file applied to remote DB, regenerated types.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and apply database migration</name>
  <files>supabase/migrations/NEW_face_verifications.sql</files>
  <action>
Create a single migration file using `supabase migration new face_verifications` (this generates the timestamped filename). The migration must contain:

1. CREATE TABLE public.face_verifications with ALL columns (designed for Phase 1-3, no future ALTER TABLEs needed):
   - id UUID PK DEFAULT gen_random_uuid()
   - time_entry_id UUID NOT NULL REFERENCES public.time_entries(id) ON DELETE CASCADE
   - profile_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE
   - company_id UUID NOT NULL REFERENCES public.companies(id) ON DELETE CASCADE
   - clock_photo_url TEXT
   - profile_photo_url TEXT
   - confidence_score NUMERIC(4,3)
   - is_match BOOLEAN
   - status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'verified', 'failed', 'no_face', 'error', 'skipped'))
   - error_message TEXT
   - verified_at TIMESTAMPTZ
   - reviewed_by UUID REFERENCES auth.users(id)
   - reviewed_at TIMESTAMPTZ
   - review_decision TEXT CHECK (review_decision IN ('approved', 'rejected'))
   - created_at TIMESTAMPTZ NOT NULL DEFAULT now()
   - updated_at TIMESTAMPTZ NOT NULL DEFAULT now()

2. Indexes:
   - idx_face_verifications_time_entry ON (time_entry_id)
   - idx_face_verifications_company ON (company_id)
   - idx_face_verifications_status ON (company_id, status)

3. RLS:
   - ENABLE ROW LEVEL SECURITY
   - SELECT policy: company_id = public.get_current_user_company_id()
   - UPDATE policy: company_id = public.get_current_user_company_id() AND public.has_role(auth.uid(), 'admin')
   - NO INSERT policy (edge function uses service_role_key which bypasses RLS)

4. ALTER TABLE public.company_features ADD COLUMN face_verification BOOLEAN NOT NULL DEFAULT false;

Then push to remote: `supabase db push --project-ref ahtiicqunajyyasuxebj`
  </action>
  <verify>
Run `supabase db push --project-ref ahtiicqunajyyasuxebj --dry-run` to confirm migration applies cleanly (or verify it already applied).
  </verify>
  <done>face_verifications table exists in remote DB with all columns, indexes, and RLS. company_features has face_verification column.</done>
</task>

<task type="auto">
  <name>Task 2: Regenerate Supabase TypeScript types</name>
  <files>src/integrations/supabase/types.ts</files>
  <action>
Run: `supabase gen types typescript --project-id ahtiicqunajyyasuxebj > src/integrations/supabase/types.ts`

After regeneration, verify the file contains:
- face_verifications table type with all columns
- face_verification boolean in company_features type

Run `npx tsc --noEmit` to confirm no TypeScript errors introduced.
  </action>
  <verify>`grep -c "face_verifications" src/integrations/supabase/types.ts` returns > 0, and `npx tsc --noEmit` passes.</verify>
  <done>types.ts contains face_verifications and face_verification types, project compiles cleanly.</done>
</task>

</tasks>

<verification>
- Migration file exists in supabase/migrations/ with face_verifications CREATE TABLE
- types.ts contains face_verifications table definition
- types.ts contains face_verification in company_features
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Database schema is fully deployed and TypeScript types are in sync. Phase 2 and 3 should not need schema changes.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
