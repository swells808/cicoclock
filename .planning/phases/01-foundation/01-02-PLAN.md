---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/functions/verify-face/index.ts
  - supabase/config.toml
  - src/components/settings/CompanyForm.tsx
autonomous: true
user_setup:
  - service: azure-face-api
    why: "Face verification requires Azure AI Face API credentials"
    env_vars:
      - name: AZURE_FACE_ENDPOINT
        source: "Azure Portal -> Face API resource -> Keys and Endpoint -> Endpoint URL"
      - name: AZURE_FACE_API_KEY
        source: "Azure Portal -> Face API resource -> Keys and Endpoint -> Key 1"

must_haves:
  truths:
    - "verify-face edge function is deployed and responds to POST with stubbed result"
    - "Azure Face API secrets are configured as edge function secrets"
    - "Admin can toggle face verification on/off in company settings"
    - "Toggle state persists across page reloads"
  artifacts:
    - path: "supabase/functions/verify-face/index.ts"
      provides: "Stubbed edge function accepting full request shape"
      contains: "time_entry_id"
    - path: "supabase/config.toml"
      provides: "Function registration"
      contains: "functions.verify-face"
    - path: "src/components/settings/CompanyForm.tsx"
      provides: "Face verification toggle switch"
      contains: "face_verification"
  key_links:
    - from: "verify-face/index.ts"
      to: "face_verifications table"
      via: "supabase.from('face_verifications').insert()"
      pattern: "face_verifications.*insert"
    - from: "CompanyForm.tsx"
      to: "company_features.face_verification"
      via: "supabase update"
      pattern: "face_verification"
---

<objective>
Create the verify-face edge function stub, configure Azure secrets, and add the face verification toggle to the admin settings UI.

Purpose: Completes all Phase 1 deliverables -- the edge function is callable (stubbed), secrets are configured, and admins can enable/disable the feature.
Output: Deployed edge function, configured secrets, working toggle UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@src/components/settings/CompanyForm.tsx
@supabase/config.toml
@supabase/functions/clock-in-out/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and deploy verify-face edge function stub</name>
  <files>supabase/functions/verify-face/index.ts, supabase/config.toml</files>
  <action>
1. Add to supabase/config.toml:
```toml
[functions.verify-face]
verify_jwt = false
```

2. Create supabase/functions/verify-face/index.ts following the exact pattern from clock-in-out/index.ts:
   - Import serve from std@0.168.0, createClient from esm.sh/@supabase/supabase-js@2
   - Inline corsHeaders (do NOT use _shared/cors.ts)
   - Handle OPTIONS preflight
   - Accept POST body: { time_entry_id, profile_id, company_id, clock_photo_url, profile_photo_url }
   - Validate required fields (time_entry_id, profile_id, company_id) -- return 400 if missing
   - Read AZURE_FACE_ENDPOINT and AZURE_FACE_API_KEY from Deno.env (check they exist, report in response)
   - Create supabase client with service role key
   - Insert a record into face_verifications with status 'pending' (this is the stub -- Phase 2 replaces with actual Azure call)
   - Return { success: true, data, azure_configured: !!(endpoint && key) }
   - Catch errors, return 500 with error message

   Use the exact code from the research document's "Edge Function Stub" section.

3. Deploy: `supabase functions deploy verify-face --project-ref ahtiicqunajyyasuxebj`

4. Set Azure secrets (use placeholder values -- user will update with real values):
```bash
supabase secrets set AZURE_FACE_ENDPOINT="https://placeholder.cognitiveservices.azure.com" --project-ref ahtiicqunajyyasuxebj
supabase secrets set AZURE_FACE_API_KEY="placeholder-key" --project-ref ahtiicqunajyyasuxebj
```
  </action>
  <verify>
Test the deployed function with curl:
```bash
curl -X POST "https://ahtiicqunajyyasuxebj.supabase.co/functions/v1/verify-face" \
  -H "Content-Type: application/json" \
  -H "apikey: [ANON_KEY]" \
  -d '{"time_entry_id":"00000000-0000-0000-0000-000000000000","profile_id":"00000000-0000-0000-0000-000000000000","company_id":"00000000-0000-0000-0000-000000000000"}'
```
Should return a JSON response (may be 500 due to FK constraints on fake UUIDs, but the function itself responds -- not a 404).
  </verify>
  <done>verify-face function deployed, responds to POST requests, Azure secrets are set (placeholders).</done>
</task>

<task type="auto">
  <name>Task 2: Add face verification toggle to CompanyForm.tsx</name>
  <files>src/components/settings/CompanyForm.tsx</files>
  <action>
Add a face_verification toggle to CompanyForm.tsx following the exact pattern of the existing photo_capture, geolocation, and employee_pin toggles:

1. Add `face_verification: false` to the features state initialization (alongside photo_capture, geolocation, employee_pin)

2. In the useEffect that loads companyFeatures, add: `face_verification: companyFeatures?.face_verification ?? false`

3. Add a Switch + Label block in the features section, following the same JSX pattern as the existing toggles:
   - Label: "Face Verification"
   - Description: "Verify employee identity by comparing clock photo to profile photo"
   - Switch checked={features.face_verification}, onCheckedChange updates features state

4. In the save handler, include face_verification in the company_features update payload.

Do NOT create a new component or settings page. Add directly to CompanyForm.tsx in the existing features section.
  </action>
  <verify>
`grep "face_verification" src/components/settings/CompanyForm.tsx` shows the toggle in state, useEffect, JSX, and save handler. `npx tsc --noEmit` passes.
  </verify>
  <done>Face verification toggle appears in admin company settings, persists on save, reads correctly on page load.</done>
</task>

</tasks>

<verification>
- verify-face function deployed and responds to HTTP requests
- supabase/config.toml has [functions.verify-face] entry
- Azure secrets set (AZURE_FACE_ENDPOINT, AZURE_FACE_API_KEY)
- CompanyForm.tsx has face_verification toggle that saves/loads correctly
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
All Phase 1 success criteria met:
1. face_verifications table exists with RLS (from Plan 01)
2. verify-face edge function deployed and responds
3. Azure secrets configured and accessible from edge function
4. Admin can toggle face verification on/off per company
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
