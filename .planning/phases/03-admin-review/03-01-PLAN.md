---
phase: 03-admin-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useFaceVerifications.ts
  - src/components/reports/TimeEntryTimelineCard.tsx
  - src/pages/AdminTimeTracking.tsx
autonomous: true

must_haves:
  truths:
    - "Flagged time entries show a visual badge (Flagged/Cleared/Rejected) in the admin time tracking view"
    - "Unflagged or unverified entries show no verification badge"
    - "Summary card shows count of unreviewed flagged entries when face_verification is enabled"
    - "All verification UI is hidden when face_verification feature flag is off"
  artifacts:
    - path: "src/hooks/useFaceVerifications.ts"
      provides: "Query hook returning verification map and flagged count"
      exports: ["useFaceVerifications", "useFlaggedCount"]
    - path: "src/components/reports/TimeEntryTimelineCard.tsx"
      provides: "Flag badge rendering in header row"
      contains: "ShieldAlert"
    - path: "src/pages/AdminTimeTracking.tsx"
      provides: "Integration of verification data into timeline cards and summary"
      contains: "useFaceVerifications"
  key_links:
    - from: "src/pages/AdminTimeTracking.tsx"
      to: "src/hooks/useFaceVerifications.ts"
      via: "hook call with entryIds"
      pattern: "useFaceVerifications"
    - from: "src/pages/AdminTimeTracking.tsx"
      to: "src/components/reports/TimeEntryTimelineCard.tsx"
      via: "flagStatus prop on TimeEntryForCard"
      pattern: "flagStatus"
---

<objective>
Add face verification flag indicators to the admin time tracking view and a flagged-entry count in the summary card.

Purpose: Admins need to see at a glance which time entries have been flagged by face verification so they can prioritize review (ADMIN-01, ADMIN-04).
Output: useFaceVerifications hook, flag badges on TimeEntryTimelineCard, flagged count in summary.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-review/03-RESEARCH.md
@src/pages/AdminTimeTracking.tsx
@src/components/reports/TimeEntryTimelineCard.tsx
@src/hooks/useCompanyFeatures.ts
@src/integrations/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFaceVerifications hook and useFlaggedCount hook</name>
  <files>src/hooks/useFaceVerifications.ts</files>
  <action>
Create a new hook file with two exported hooks:

1. `useFaceVerifications(entryIds: string[], enabled: boolean)`:
   - Uses `useQuery` with queryKey `['face-verifications', entryIds]`.
   - Fetches from `face_verifications` table using `.in('time_entry_id', entryIds)` when entryIds is non-empty.
   - Returns a `Map<string, FaceVerification>` keyed by `time_entry_id`.
   - When multiple verifications exist for one entry (clock-in + clock-out), keep the one where `is_match = false` (worst case). If both match, keep the latest by `created_at`.
   - Import the Row type from `@/integrations/supabase/types` (`Database['public']['Tables']['face_verifications']['Row']`). Export it as `FaceVerification`.
   - enabled param gates the query (pass `false` when feature flag is off).

2. `useFlaggedCount(companyId: string | undefined, enabled: boolean)`:
   - Uses `useQuery` with queryKey `['flagged-count', companyId]`.
   - Fetches count using `.select('*', { count: 'exact', head: true }).eq('company_id', companyId).eq('is_match', false).is('review_decision', null)`.
   - Returns the count number (default 0).
   - enabled param gates the query.

Both hooks use `supabase` from `@/integrations/supabase/client` and `useQuery` from `@tanstack/react-query`.

Do NOT use Supabase relational joins -- use manual `.in()` query (matches existing codebase pattern).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit --pretty 2>&1 | head -30`</verify>
  <done>Both hooks export correctly, types are inferred from generated Supabase types, no manual type duplication.</done>
</task>

<task type="auto">
  <name>Task 2: Add flag badge to TimeEntryTimelineCard and wire into AdminTimeTracking</name>
  <files>src/components/reports/TimeEntryTimelineCard.tsx, src/pages/AdminTimeTracking.tsx</files>
  <action>
**TimeEntryTimelineCard.tsx changes:**

1. Add `flagStatus?: 'flagged' | 'approved' | 'rejected' | null` to the `TimeEntryForCard` interface.
2. Add `onReviewClick?: () => void` to `TimeEntryTimelineCardProps` (will be used in Plan 02 to open the review dialog).
3. Import `ShieldAlert`, `ShieldCheck`, `ShieldX` from `lucide-react`.
4. In the header row (the div with `flex items-center gap-3 flex-wrap`), after the existing `{getStatusBadge()}`, add flag badges gated on `entry.flagStatus`:
   - `flagStatus === 'flagged'`: Red destructive Badge with ShieldAlert icon, text "Flagged", clickable if `onReviewClick` is provided (wrap in button/span with onClick).
   - `flagStatus === 'approved'`: Green outline Badge with ShieldCheck icon, text "Cleared".
   - `flagStatus === 'rejected'`: Red outline Badge with ShieldX icon, text "Rejected".
   - `null` or `undefined`: render nothing.

**AdminTimeTracking.tsx changes:**

1. Import `useFaceVerifications` and `useFlaggedCount` from `@/hooks/useFaceVerifications`.
2. After the existing time entries query, call `useFaceVerifications`:
   ```
   const entryIds = useMemo(() => timeEntries.map(e => e.id), [timeEntries]);
   const { data: verificationMap } = useFaceVerifications(entryIds, !!companyFeatures?.face_verification);
   ```
3. Call `useFlaggedCount`:
   ```
   const { data: flaggedCount = 0 } = useFlaggedCount(company?.id, !!companyFeatures?.face_verification);
   ```
4. In the `transformedEntries` useMemo, add `flagStatus` to each entry:
   ```
   const verification = verificationMap?.get(entry.id);
   let flagStatus: 'flagged' | 'approved' | 'rejected' | null = null;
   if (verification) {
     if (!verification.is_match && !verification.review_decision) flagStatus = 'flagged';
     else if (verification.review_decision === 'approved') flagStatus = 'approved';
     else if (verification.review_decision === 'rejected') flagStatus = 'rejected';
   }
   ```
   Add `flagStatus` to the returned object. Add `verificationMap` to the useMemo dependency array.
5. In the Summary card (the Card with "Summary" title), add a new row below "Completed" that only renders when `companyFeatures?.face_verification && flaggedCount > 0`:
   ```
   <div className="flex justify-between text-sm">
     <span className="text-muted-foreground">Flagged:</span>
     <span className="font-medium text-destructive">{flaggedCount}</span>
   </div>
   ```
  </action>
  <verify>
1. `npx tsc --noEmit --pretty 2>&1 | head -30` -- no type errors.
2. `npm run build 2>&1 | tail -20` -- builds successfully.
  </verify>
  <done>
- TimeEntryTimelineCard shows Flagged/Cleared/Rejected badges based on flagStatus prop.
- AdminTimeTracking fetches verifications, maps them to entries, passes flagStatus.
- Summary card shows flagged count when face_verification enabled and count > 0.
- All verification UI hidden when feature flag is off.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors.
2. Production build succeeds.
3. TimeEntryForCard interface includes flagStatus field.
4. AdminTimeTracking imports and uses both hooks.
5. Summary card conditionally shows flagged count.
6. All new UI gated behind companyFeatures?.face_verification.
</verification>

<success_criteria>
- Flagged entries display a red "Flagged" badge with ShieldAlert icon in the timeline card header.
- Approved entries display a green "Cleared" badge; rejected entries display a red "Rejected" badge.
- Summary card shows "Flagged: N" count when there are unreviewed flagged entries.
- No verification UI appears when face_verification feature is disabled.
- Build passes cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-review/03-01-SUMMARY.md`
</output>
