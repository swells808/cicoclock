---
phase: 03-admin-review
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/admin/FaceReviewDialog.tsx
  - src/pages/AdminTimeTracking.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can click a flagged entry to open a side-by-side photo comparison dialog"
    - "Dialog shows profile photo on left, clock photo on right, with confidence score"
    - "Admin can approve (dismiss flag) or reject (confirm fraud) and the decision persists in the database"
    - "After review, the flag badge updates without page refresh"
  artifacts:
    - path: "src/components/admin/FaceReviewDialog.tsx"
      provides: "Side-by-side photo review dialog with approve/reject actions"
      exports: ["FaceReviewDialog"]
    - path: "src/pages/AdminTimeTracking.tsx"
      provides: "Dialog integration with state management and cache invalidation"
      contains: "FaceReviewDialog"
  key_links:
    - from: "src/components/admin/FaceReviewDialog.tsx"
      to: "face_verifications"
      via: "supabase update on approve/reject"
      pattern: "supabase.*face_verifications.*update"
    - from: "src/pages/AdminTimeTracking.tsx"
      to: "src/components/admin/FaceReviewDialog.tsx"
      via: "dialog open state + selected verification"
      pattern: "FaceReviewDialog"
    - from: "src/components/admin/FaceReviewDialog.tsx"
      to: "react-query cache"
      via: "queryClient.invalidateQueries on success"
      pattern: "invalidateQueries"
---

<objective>
Build the side-by-side photo review dialog and wire approve/reject actions so admins can resolve flagged entries.

Purpose: Admins need to compare the profile photo against the clock photo, see the confidence score, and make an approve/reject decision that persists (ADMIN-02, ADMIN-03).
Output: FaceReviewDialog component, full wiring in AdminTimeTracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-review/03-RESEARCH.md
@.planning/phases/03-admin-review/03-01-SUMMARY.md
@src/pages/AdminTimeTracking.tsx
@src/components/reports/TimeEntryTimelineCard.tsx
@src/hooks/useFaceVerifications.ts
@src/components/admin/EditTimeEntryDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FaceReviewDialog component</name>
  <files>src/components/admin/FaceReviewDialog.tsx</files>
  <action>
Create a new dialog component following the existing `EditTimeEntryDialog` pattern:

**Props interface:**
```typescript
interface FaceReviewDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  verification: FaceVerification | null;
  onSuccess: () => void;
}
```

Import `FaceVerification` from `@/hooks/useFaceVerifications`.

**Dialog content:**
1. Use shadcn `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogDescription`, `DialogFooter`.
2. Set `DialogContent` to `className="max-w-2xl"` for wider layout.
3. **Photo comparison grid:** `grid grid-cols-2 gap-4`
   - Left column: "Profile Photo" label + `<img>` with profile photo signed URL. Show placeholder div with text "No profile photo" if null.
   - Right column: "Clock Photo" label + `<img>` with clock photo signed URL. Show placeholder if null.
   - Both images: `className="w-full aspect-square object-cover rounded-lg border"`.
4. **Confidence score:** Below the grid, centered text showing `Confidence: {(verification.confidence_score * 100).toFixed(1)}%`. Color the text: red if < 50%, orange if 50-80%, green if >= 80%.
5. **Match status:** Below confidence, show `is_match` status: "Match: Yes" (green) or "Match: No" (red).
6. **Signed URLs:** The dialog needs signed URLs for both photos. Inside the component, use a `useEffect` to fetch signed URLs from Supabase storage when the dialog opens:
   - `verification.profile_photo_url` -> sign from `timeclock-photos` bucket.
   - `verification.clock_photo_url` -> sign from `timeclock-photos` bucket.
   - Store in local state. Show loading skeleton while fetching.
7. **Action buttons in DialogFooter:**
   - "Approve (Dismiss Flag)" button: green variant (`className="bg-green-600 hover:bg-green-700 text-white"`). Calls handleReview('approved').
   - "Reject (Confirm Fraud)" button: red destructive variant. Calls handleReview('rejected').
   - Both disabled while submitting (use loading state).
8. **handleReview function:**
   ```typescript
   const handleReview = async (decision: 'approved' | 'rejected') => {
     setSubmitting(true);
     const { data: { user } } = await supabase.auth.getUser();
     const { error } = await supabase
       .from('face_verifications')
       .update({
         review_decision: decision,
         reviewed_by: user?.id,
         reviewed_at: new Date().toISOString(),
       })
       .eq('id', verification!.id);
     setSubmitting(false);
     if (!error) {
       onSuccess();
       onOpenChange(false);
     }
   };
   ```
9. If `verification` is null, render nothing (early return before Dialog).
10. Show the employee name if available (verification has `time_entry_id` -- the parent page can pass it as an extra prop, or show the verification ID). Add an optional `employeeName?: string` prop for display in the header.

Use `useQueryClient` from `@tanstack/react-query` -- but do NOT invalidate here. Let the parent `onSuccess` handle cache invalidation.
  </action>
  <verify>`npx tsc --noEmit --pretty 2>&1 | head -30` -- no type errors.</verify>
  <done>FaceReviewDialog renders side-by-side photos, confidence score, match status, and approve/reject buttons that persist decisions to the database.</done>
</task>

<task type="auto">
  <name>Task 2: Wire FaceReviewDialog into AdminTimeTracking</name>
  <files>src/pages/AdminTimeTracking.tsx</files>
  <action>
**Add dialog state and wiring:**

1. Import `FaceReviewDialog` from `@/components/admin/FaceReviewDialog`.
2. Import `FaceVerification` from `@/hooks/useFaceVerifications`.
3. Import `useQueryClient` from `@tanstack/react-query`.
4. Add state:
   ```typescript
   const [reviewDialogOpen, setReviewDialogOpen] = useState(false);
   const [reviewingVerification, setReviewingVerification] = useState<FaceVerification | null>(null);
   const [reviewingEmployeeName, setReviewingEmployeeName] = useState<string>('');
   const queryClient = useQueryClient();
   ```
5. Create handler:
   ```typescript
   const handleReviewClick = (entryId: string) => {
     const verification = verificationMap?.get(entryId);
     if (!verification) return;
     const entry = filteredEntries.find(e => e.id === entryId);
     setReviewingVerification(verification);
     setReviewingEmployeeName(getProfileDisplayName(entry?.profiles || null));
     setReviewDialogOpen(true);
   };
   ```
6. In the `transformedEntries` map inside the JSX (where `TimeEntryTimelineCard` is rendered), pass `onReviewClick`:
   ```tsx
   <TimeEntryTimelineCard
     key={transformedEntry.id}
     entry={transformedEntry}
     onReviewClick={
       transformedEntry.flagStatus === 'flagged' && isAdmin && companyFeatures?.face_verification
         ? () => handleReviewClick(transformedEntry.id)
         : undefined
     }
     onEdit={...existing...}
   />
   ```
7. Add the dialog component after the existing `EditTimeEntryDialog`, gated on admin + feature flag:
   ```tsx
   {isAdmin && companyFeatures?.face_verification && (
     <FaceReviewDialog
       open={reviewDialogOpen}
       onOpenChange={setReviewDialogOpen}
       verification={reviewingVerification}
       employeeName={reviewingEmployeeName}
       onSuccess={() => {
         queryClient.invalidateQueries({ queryKey: ['face-verifications'] });
         queryClient.invalidateQueries({ queryKey: ['flagged-count'] });
         setReviewDialogOpen(false);
         setReviewingVerification(null);
       }}
     />
   )}
   ```

This wires the "Flagged" badge click (from Plan 01's `onReviewClick` prop) to open the review dialog, and invalidates both verification queries on success so the badge updates and the flagged count decrements.
  </action>
  <verify>
1. `npx tsc --noEmit --pretty 2>&1 | head -30` -- no type errors.
2. `npm run build 2>&1 | tail -20` -- builds successfully.
  </verify>
  <done>
- Clicking "Flagged" badge on a timeline card opens the FaceReviewDialog.
- Dialog shows side-by-side photos with confidence score.
- Approve/reject persists to database and updates UI without page refresh.
- Dialog only accessible to admins with face_verification enabled.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors.
2. Production build succeeds.
3. FaceReviewDialog component exists with approve/reject functionality.
4. AdminTimeTracking wires dialog open/close and cache invalidation.
5. Review decisions persist (review_decision, reviewed_by, reviewed_at columns updated).
6. Flag badge updates after review without page refresh.
</verification>

<success_criteria>
- Admin clicks "Flagged" badge -> dialog opens with profile photo (left) and clock photo (right).
- Confidence score displayed with color coding.
- "Approve" sets review_decision='approved', "Reject" sets review_decision='rejected'.
- After review, badge changes from "Flagged" to "Cleared" or "Rejected" without refresh.
- Flagged count in summary decrements after review.
- Build passes cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-review/03-02-SUMMARY.md`
</output>
