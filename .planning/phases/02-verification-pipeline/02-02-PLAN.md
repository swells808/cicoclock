---
phase: 02-verification-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/pages/Timeclock.tsx
autonomous: true

must_haves:
  truths:
    - "After clock-in/out with a photo, verify-face is invoked without blocking the clock action"
    - "verify-face is only called when face_verification feature is enabled"
    - "Clock-in/out succeeds even if verify-face invocation fails"
    - "When employee has no profile photo, verify-face is not called"
  artifacts:
    - path: "src/pages/Timeclock.tsx"
      provides: "Fire-and-forget verify-face calls after clock actions"
      contains: "verify-face"
  key_links:
    - from: "src/pages/Timeclock.tsx"
      to: "verify-face edge function"
      via: "supabase.functions.invoke('verify-face', ...) without await"
      pattern: "functions\\.invoke\\('verify-face'"
    - from: "src/pages/Timeclock.tsx"
      to: "useCompanyFeatures"
      via: "features?.face_verification check before invoke"
      pattern: "face_verification.*verify-face|verify-face.*face_verification"
---

<objective>
Wire the Timeclock frontend to fire-and-forget call verify-face after every successful clock-in/out that has a photo. The call must never block or delay the clock action.

Purpose: This completes the async verification pipeline (VCORE-02, VCORE-04).
Output: Timeclock.tsx triggers verify-face after clock actions, gated by feature flag and photo availability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-verification-pipeline/02-RESEARCH.md
@.planning/phases/02-verification-pipeline/02-01-SUMMARY.md

Key source files:
@src/pages/Timeclock.tsx (modify -- add verify-face calls)
@src/hooks/useCompanyFeatures.ts (read -- understand feature flag access)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fire-and-forget verify-face calls to clock-in/out</name>
  <files>src/pages/Timeclock.tsx</files>
  <action>
In `src/pages/Timeclock.tsx`, add verify-face invocation after each successful clock-in/out. There are three places to add it:

1. **`performClockIn`** (around line 388, after the success check `if (error || !data?.success)` block):
   After confirming clock-in succeeded, before the toast/reset, add:
   ```typescript
   // Fire-and-forget face verification
   if (companyFeatures?.face_verification && photoUrl && authenticatedEmployee?.avatar_url) {
     supabase.functions.invoke('verify-face', {
       body: {
         time_entry_id: data.data.id,
         profile_id: authenticatedEmployee.id,
         company_id: company.id,
         clock_photo_url: photoUrl,
         profile_photo_url: authenticatedEmployee.avatar_url,
       },
     }).catch(() => {}); // Suppress unhandled rejection
   }
   ```

2. **`performClockOut`** (around line 432, after success check):
   Same pattern, but use the clock-out photo URL and the returned time entry id.

3. **`handleBreak`** (around line 460, after success check):
   Same pattern if the break action returns a time entry id and has a photo. If breaks don't take photos (check the code), skip this one.

CRITICAL RULES:
- Do NOT `await` the verify-face call. It must be fire-and-forget.
- Add `.catch(() => {})` to suppress unhandled promise rejection warnings.
- Gate on THREE conditions: `companyFeatures?.face_verification` AND `photoUrl` (truthy) AND `authenticatedEmployee?.avatar_url` (truthy).
- If any condition is false, simply skip -- no error, no log needed.
- Use `data.data.id` for `time_entry_id` (check the actual response shape from clock-in-out; it may be `data.data.id` or `data.id` -- inspect the response).

Look at how `companyFeatures` is accessed in the component. It may be from `useCompanyFeatures()` hook or a prop. Use whatever pattern already exists in the file.
  </action>
  <verify>
1. `grep -n "verify-face" src/pages/Timeclock.tsx` shows the function is invoked in performClockIn and performClockOut
2. `grep -n "await.*verify-face" src/pages/Timeclock.tsx` returns NO results (must NOT be awaited)
3. `grep -n "face_verification" src/pages/Timeclock.tsx` shows the feature flag check
4. `npm run build` or `npx tsc --noEmit` passes without type errors
  </verify>
  <done>
Timeclock.tsx fires verify-face after successful clock-in and clock-out, gated by face_verification feature flag + photo availability + profile photo existence. The call is fire-and-forget (not awaited). Build passes.
  </done>
</task>

</tasks>

<verification>
1. Clock-in/out flow is NOT blocked by verify-face (no await on the invoke call)
2. Feature flag check prevents unnecessary calls when face_verification is disabled
3. Missing profile photo gracefully skips verification (no call made)
4. TypeScript compiles without errors
</verification>

<success_criteria>
- verify-face is called fire-and-forget after clock-in and clock-out
- Three-way gate: feature enabled + clock photo exists + profile photo exists
- Clock action timing is unchanged (no awaiting verify-face)
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-verification-pipeline/02-02-SUMMARY.md`
</output>
