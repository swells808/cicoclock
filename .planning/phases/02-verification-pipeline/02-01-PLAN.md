---
phase: 02-verification-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/verify-face/index.ts
autonomous: true

must_haves:
  truths:
    - "verify-face edge function calls Azure Face API detect + verify"
    - "Every invocation produces a face_verifications record regardless of outcome"
    - "All failure modes (no photo, no face, API error, timeout) result in appropriate status, never an unhandled crash"
  artifacts:
    - path: "supabase/functions/verify-face/index.ts"
      provides: "Complete Azure Face API verification logic"
      contains: "face/v1.2/detect"
  key_links:
    - from: "supabase/functions/verify-face/index.ts"
      to: "Azure Face API"
      via: "fetch with Ocp-Apim-Subscription-Key header"
      pattern: "Ocp-Apim-Subscription-Key"
    - from: "supabase/functions/verify-face/index.ts"
      to: "face_verifications table"
      via: "supabase .from('face_verifications').update()"
      pattern: "face_verifications.*update"
---

<objective>
Replace the verify-face edge function stub with real Azure Face API integration. The function will: detect faces in both clock photo and profile photo, verify they match, and store the result. All failure modes produce a database record with appropriate status.

Purpose: This is the core verification logic (VCORE-01, VCORE-03, VCORE-05).
Output: Working verify-face edge function with Azure Face API calls and comprehensive error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-verification-pipeline/02-RESEARCH.md

Key source files:
@supabase/functions/verify-face/index.ts (current stub -- replace contents)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Azure Face API verification in edge function</name>
  <files>supabase/functions/verify-face/index.ts</files>
  <action>
Replace the stub in `supabase/functions/verify-face/index.ts` with the complete verification flow from the RESEARCH.md code example. The function must:

1. Parse request body: `{ time_entry_id, profile_id, company_id, clock_photo_url, profile_photo_url }`
2. Validate required fields (return 400 if missing)
3. Insert a `pending` record into `face_verifications` and capture its `id`
4. Check Azure secrets exist (`AZURE_FACE_ENDPOINT`, `AZURE_FACE_API_KEY`). If missing, update record to `error` status.
5. Check both photo URLs. If either missing, update to `skipped` with message.
6. Download each image as bytes (`fetch` -> `arrayBuffer` -> `Uint8Array`)
7. Call Azure Face API v1.2 detect for each image (binary mode, `Content-Type: application/octet-stream`, params: `detectionModel=detection_03&recognitionModel=recognition_04&returnFaceId=true&faceIdTimeToLive=120`)
8. If no face detected in either image, update to `no_face` with message
9. Call Azure Face API v1.2 verify with both faceIds
10. Update record: `status='verified'`, `confidence_score`, `is_match`, `verified_at`
11. Catch-all: any unhandled error updates the record to `error` status with the error message

Helper functions to implement:
- `updateRecord(supabase, id, fields)` -- updates face_verifications by id
- `detectFace(endpoint, apiKey, imageUrl)` -- downloads image bytes, calls detect, returns faceId or null
- `verifyFaces(endpoint, apiKey, faceId1, faceId2)` -- calls verify, returns `{ isIdentical, confidence }`
- `fetchWithTimeout(url, options, timeoutMs)` -- fetch with AbortController timeout (25s for Azure, 15s for image download)
- `jsonResponse(body)` -- returns Response with CORS headers and JSON content type

Use the RESEARCH.md code example as the primary reference. Keep CORS headers. Use `SUPABASE_SERVICE_ROLE_KEY` for the supabase client (bypass RLS). Do NOT use `verify_jwt: false` -- that was set in Phase 1 deployment config, not in code.

IMPORTANT: Do NOT use Azure Node.js SDK -- use native `fetch` only (Deno runtime).
  </action>
  <verify>
Run `deno check supabase/functions/verify-face/index.ts` (or at minimum, visually confirm no syntax errors and all helper functions are defined). Verify the file contains: `face/v1.2/detect`, `face/v1.2/verify`, `fetchWithTimeout`, `updateRecord`, `detectFace`, `verifyFaces`, and handles all status values: `pending`, `verified`, `skipped`, `no_face`, `error`.
  </verify>
  <done>
verify-face edge function contains complete Azure Face API integration with detect+verify flow, comprehensive error handling for all failure modes (missing photos, no face, API errors, timeouts, missing secrets), and every code path writes a face_verifications record.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy updated edge function</name>
  <files>supabase/functions/verify-face/index.ts</files>
  <action>
Deploy the updated verify-face edge function to Supabase:

```bash
supabase functions deploy verify-face --no-verify-jwt
```

The `--no-verify-jwt` flag is needed because the function is called from the client with the anon key (decided in Phase 1, see STATE.md).

If deployment fails due to CLI issues (known Supabase CLI v2.72.7 problems), note the error but do not block -- the function can be deployed manually or via CI later.
  </action>
  <verify>
Deployment command completes successfully, or if it fails, the error is documented. Check with `supabase functions list` or `supabase functions serve verify-face` locally to confirm the function is syntactically valid.
  </verify>
  <done>
verify-face edge function is deployed (or deployment attempted with error documented if CLI issue). Function code is correct and ready to receive invocations.
  </done>
</task>

</tasks>

<verification>
1. The file `supabase/functions/verify-face/index.ts` contains Azure Face API detect and verify calls
2. All error/skip paths update the face_verifications record (grep for `updateRecord` calls)
3. AbortController timeout is used for Azure API calls
4. Binary image mode is used (octet-stream, not URL mode)
</verification>

<success_criteria>
- verify-face edge function implements full Azure Face API detect+verify pipeline
- Every failure mode (missing photos, no face, API error, timeout, missing secrets) writes a record
- Function is deployed or ready to deploy
</success_criteria>

<output>
After completion, create `.planning/phases/02-verification-pipeline/02-01-SUMMARY.md`
</output>
